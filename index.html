<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jogo de Reflexos - Visual Mídia Leme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset para tela 4K */
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-size: 1.5vw;
            touch-action: manipulation;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            touch-action: manipulation;
            background: linear-gradient(45deg, #3b82f6, #f97316, #8b5cf6, #3b82f6);
            background-size: 300% 300%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Container principal ajustado para 4K */
        #app {
            width: 90vw;
            height: 90vh;
            max-width: 3840px;
            max-height: 2160px;
            position: relative;
            overflow: hidden;
        }

        /* Ajustes de tamanho para todos os elementos */
        .game-container {
            perspective: 1000px;
        }

        .square {
            transition: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            border-radius: 1vw;
            touch-action: manipulation;
        }

        .square.active {
            will-change: transform, opacity;
            background-color: #3b82f6;
            transform: scale(0.95);
            box-shadow: 0 0 15px #3b82f6;
        }

        .square.wrong {
            background-color: #ef4444;
            transform: scale(0.95);
            animation: wrongFlash 0.2s ease-out;
        }

        @keyframes wrongFlash {
            0%, 100% { background-color: #ef4444; }
            50% { background-color: #ff0000; }
        }

        /* Efeitos de animação */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .shake {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }

        /* Efeito de vidro quebrando melhorado */
        @keyframes crack {
            0% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
                filter: brightness(1);
            }
            100% {
                transform: scale(1.5) rotate(10deg);
                opacity: 0;
                filter: brightness(1.5);
            }
        }

        .crack-effect {
            pointer-events: none;
            will-change: transform, opacity;
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(45deg, transparent 48%, white 48%, white 52%, transparent 52%),
                linear-gradient(-45deg, transparent 48%, white 48%, white 52%, transparent 52%),
                radial-gradient(circle at 30% 30%, transparent 40%, white 41%, white 42%, transparent 43%),
                radial-gradient(circle at 70% 70%, transparent 40%, white 41%, white 42%, transparent 43%),
                radial-gradient(circle at 20% 50%, transparent 40%, white 41%, white 42%, transparent 43%),
                radial-gradient(circle at 80% 50%, transparent 40%, white 41%, white 42%, transparent 43%),
                radial-gradient(circle at 50% 20%, transparent 40%, white 41%, white 42%, transparent 43%),
                radial-gradient(circle at 50% 80%, transparent 40%, white 41%, white 42%, transparent 43%);
            background-size: 100% 100%;
            animation: crack 0.6s ease-out forwards;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        .crack-effect::before {
            pointer-events: none;
            will-change: transform, opacity;
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(255,255,255,0.8) 0%, transparent 70%);
            opacity: 0;
            animation: crackGlow 0.6s ease-out forwards;
        }

        @keyframes crackGlow {
            0% { opacity: 0; }
            20% { opacity: 0.8; }
            100% { opacity: 0; }
        }

        .flying-shard {
            pointer-events: none;
            position: absolute;
            background: white;
            opacity: 0.8;
            animation: flyShard 0.8s ease-out forwards;
            z-index: 10;
        }

        @keyframes flyShard {
            0% {
                transform: translate3d(0, 0) rotate(0deg) scale(1);
                opacity: 0.8;
            }
            100% {
                transform: translate3d(var(--tx), var(--ty)) rotate(var(--rot)) scale(0);
                opacity: 0;
            }
        }

        /* Pódio ajustado para 4K - TAMANHOS REDUZIDOS */
        .podium-1 {
            height: 12vh;  /* Reduzido de 25vh */
            background: linear-gradient(to bottom, #ffd700, #f9c712);
        }

        .podium-2 {
            height: 10vh;  /* Reduzido de 20vh */
            background: linear-gradient(to bottom, #c0c0c0, #b0b0b0);
        }

        .podium-3 {
            height: 8vh;   /* Reduzido de 15vh */
            background: linear-gradient(to bottom, #cd7f32, #b87333);
        }

        /* Countdown ajustado */
        .countdown-container {
            position: relative;
            width: 10vw;
            height: 10vw;
            margin-bottom: 3vh;
        }

        .countdown-svg {
            transform: rotate(-90deg);
        }

        .countdown-circle-bg {
            stroke: #4b5563;
            stroke-width: 8;
            fill: none;
        }

        .countdown-circle {
            stroke: #3b82f6;
            stroke-width: 8;
            stroke-linecap: round;
            fill: none;
            transition: stroke-dashoffset 1s linear;
        }

        /* Animações */
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-1vh); }
        }

        .bounce {
            animation: bounce 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 1.5s infinite;
        }

        /* Estilos de medalhas */
        .medal-gold {
            color: #ffd700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.7);
        }

        .medal-silver {
            color: #c0c0c0;
            text-shadow: 0 0 5px rgba(192, 192, 192, 0.7);
        }

        .medal-bronze {
            color: #cd7f32;
            text-shadow: 0 0 5px rgba(205, 127, 50, 0.7);
        }

        /* Botões ajustados */
        .pixel-btn {
            position: relative;
            border: 0.5vw solid #000;
            box-shadow: 0.5vw 0.5vw 0 rgba(0,0,0,0.2);
            transition: none !important;
            font-size: 2vw;
            padding: 2vh 3vw;
            margin: 1vh 0;
            touch-action: manipulation;
        }

        .pixel-btn:hover {
            transform: translate3d(0.3vw, 0.3vw);
            box-shadow: 0.3vw 0.3vw 0 rgba(0,0,0,0.2);
        }

        .pixel-btn:active {
            will-change: transform, opacity;
            transform: translate3d(0.5vw, 0.5vw);
            box-shadow: none;
        }

        /* Ranking ajustado */
        #ranking-list {
            max-height: none;
            overflow-y: visible;
            scrollbar-width: none;
        }

        #ranking-list::-webkit-scrollbar {
            display: none;
        }

        .ranking-item {
            font-size: 1.6vw;
            padding: 1.2vh 1.2vw;
            margin: 0.8vh 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(59, 130, 246, 0.3);
            border-radius: 1vw;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .player-position {
            font-weight: bold;
            width: 16%;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-name {
            font-weight: bold;
            flex: 1;
            padding: 0 1.5vw;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .player-score {
            color: white;
            width: 24%;
            text-align: right;
        }

        /* Títulos ajustados */
        h1 {
            font-size: 4vw;
            margin-bottom: 3vh;
        }

        h2 {
            font-size: 3vw;
            margin-bottom: 2vh;
        }

        /* Partículas de fundo */
        #particles {
            pointer-events: none;
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* Efeito de brilho no texto */
        .player-name {
            font-family: 'Bungee', cursive;
            background: linear-gradient(90deg, #ff8a00, #e52e71, #ff8a00);
            background-size: 200% auto;
            color: transparent;
            -webkit-background-clip: text;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            animation: shine 3s linear infinite;
            letter-spacing: 1px;
            font-size: 1.6vw;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }

        /* Ajuste para o tabuleiro do jogo */
        #game-board {
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5vw;
            width: 60vw;
            max-width: none;
        }

        /* Ajuste para o logo */
        .logo-container {
            width: 18vw;
            height: 18vw;
            margin-bottom: 4vh;
        }

        /* Ajuste para o Instagram */
        .instagram-pixel {
            width: 5vw;
            height: 5vw;
            border-radius: 1.2vw;
        }

        .instagram-pixel::before {
            width: 3.5vw;
            height: 3.5vw;
            border-radius: 0.8vw;
            border: 0.4vw solid white;
        }

        .instagram-pixel::after {
            width: 1.2vw;
            height: 1.2vw;
        }

        /* Botão de voltar no ranking */
        .ranking-back-btn {
            position: absolute;
            top: 2vh;
            right: 2vw;
            z-index: 20;
            width: 4vw;
            height: 4vw;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* Centralizar título do ranking */
        .ranking-header {
            display: flex;
            justify-content: center;
            margin-bottom: 2vh;
        }

        /* Estilo para o jogador fora do top 10 */
        .player-outside-top {
            background: rgba(255, 255, 255, 0.2) !important;
            border: none;
            margin-top: 2vh;
            padding: 1.5vh 1.5vw;
            border-radius: 1vw;
            font-size: 1.6vw;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            transition: all 0.3s ease;
        }

        .player-outside-top:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .current-player-name {
            font-family: 'Bungee', cursive;
            color: white;
            text-shadow: 0 0 5px rgba(255,255,255,0.5);
            letter-spacing: 1px;
            font-size: 1.6vw;
            font-weight: bold;
            flex: 1;
            padding: 0 1.5vw;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .current-player-score {
            color: white;
            width: 24%;
            text-align: right;
        }

        .logo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Estilos adicionados para as medalhas */
        .medal-icon {
            font-size: 1.5vw;
            margin-left: 0.5vw;
        }

        .ranking-container {
            height: auto;
            max-height: 80vh;
            overflow-y: visible;
            padding-bottom: 2vh;
        }

        /* Ajuste para o pódio */
        .podium-container {
            margin-bottom: 2vh;
        }
    </style>
</head>
<body>
    <div id="app" class="flex flex-col items-center justify-center p-4">
        <!-- Particle background -->
        <div id="particles" class="absolute inset-0 pointer-events-none"></div>

        <!-- Tela Inicial -->
        <div id="start-screen" class="flex flex-col items-center justify-center text-center w-full h-full relative z-10">
            <!-- Logo -->
            <div class="logo-container flex items-center justify-center bg-white/20 rounded-full backdrop-blur-sm border-2 border-white/30">
                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTo9TY0cHKsQJaxM0dSpUZA-r-N_k1lkUU_ig&s" alt="Logo da Escola" class="logo-img">
            </div>
            
            <h1 class="text-white bounce text-6xl">VM TAP</h1>
            <div class="space-y-4 w-full max-w-xl">
                <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg pulse pixel-btn">
                    JOGAR
                </button>
                <button id="ranking-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg pixel-btn">
                    RANKING
                </button>
            </div>
            <div class="absolute bottom-0 text-white/80 text-xl">
                Siga nosso Instagram: <span class="font-bold">@visualmidialeme</span>
            </div>
        </div>

        <!-- Tela do Jogo -->
        <div id="game-screen" class="hidden w-full h-full flex flex-col items-center justify-center relative z-10">
            <div class="countdown-container">
                <svg class="countdown-svg" width="100%" height="100%" viewBox="0 0 100 100">
                    <circle class="countdown-circle-bg" cx="50" cy="50 r="45"></circle>
                    <circle id="countdown-circle" class="countdown-circle" cx="50" cy="50" r="45"></circle>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center text-4xl font-bold">
                    <span id="time-left">20</span>
                </div>
            </div>
            
            <div class="mb-8 text-3xl font-bold">
                Pontos: <span id="score">0</span>
            </div>
            
            <div id="game-board" class="grid w-full">
                <!-- Squares will be generated by JavaScript -->
            </div>
        </div>

        <!-- Tela de Agradecimento -->
        <div id="thanks-screen" class="hidden w-full h-full flex flex-col items-center justify-center text-center px-8 relative z-10">
            <div class="bg-white/10 backdrop-blur-sm p-12 rounded-3xl border border-white/20 max-w-2xl w-full">
                <h2 class="font-bold mb-12">OBRIGADO POR JOGAR!</h2>
                
                <p class="text-3xl mb-12">Esperamos que tenha se divertido!</p>
                
                <div class="flex flex-col items-center space-y-6 mb-12">
                    <p class="text-2xl">Você já segue nosso Instagram?</p>
                    <div class="flex items-center space-x-4">
                        <span class="instagram-pixel"></span>
                        <span class="font-bold text-3xl">@visualmidialeme</span>
                    </div>
                </div>
                
                <button id="continue-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg pixel-btn w-full text-3xl py-6">
                    CONTINUAR PARA O RANKING
                </button>
            </div>
        </div>

        <!-- Tela de Cadastro de Nome -->
        <div id="name-screen" class="hidden w-full h-full flex flex-col items-center justify-center text-center px-8 relative z-10">
            <div class="bg-white/10 backdrop-blur-sm p-12 rounded-3xl border border-white/20 max-w-2xl w-full">
                <h2 class="font-bold mb-8">REGISTRE SEU NOME</h2>
                <p class="text-3xl mb-12">Sua pontuação: <span id="final-score" class="font-bold text-blue-400">0</span></p>
                
                <div class="w-full mb-12">
                    <label for="player-name" class="block text-2xl mb-4">DIGITE SEU NOME:</label>
                    <input type="text" id="player-name" maxlength="20" class="w-full rounded-xl text-gray-800 text-center font-bold" placeholder="SEU NICK">
                </div>
                
                <button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg pixel-btn text-3xl py-6">
                    SALVAR E VER RANKING
                </button>
            </div>
        </div>

        <!-- Tela de Ranking - MODIFICADA COM PÓDIOS MENORES E SEM BOTÃO DE VOLTAR -->
        <div id="ranking-screen" class="hidden w-full h-full flex flex-col items-center justify-start pt-12 px-8 relative z-10">
            <!-- Botão de voltar -->
            <button id="ranking-back-btn" class="ranking-back-btn bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-full transition-all duration-300 transform hover:scale-105 shadow-lg">
                <i class="fas fa-home text-2xl"></i>
            </button>
            
            <div class="bg-white/10 backdrop-blur-sm p-8 rounded-3xl border border-white/20 w-full max-w-4xl ranking-container">
                <!-- Título centralizado -->
                <div class="ranking-header">
                    <h2 class="text-5xl font-bold text-yellow-400">RANKING</h2>
                </div>
                
                <div class="podium-container flex items-end justify-center space-x-6 mb-6 w-full">
                    <div class="flex flex-col items-center">
                        <div class="podium-2 w-28 rounded-t-2xl flex items-end justify-center pb-4">
                            <span class="text-4xl font-bold">2º</span>
                        </div>
                        <div class="bg-gray-700/50 w-full py-4 rounded-b-2xl text-center">
                            <span id="second-place" class="block font-bold text-2xl truncate px-2 second-place-name">---</span>
                            <span id="second-score" class="text-xl player-score">0 pts</span>
                            <div class="mt-2">
                                <i class="fas fa-medal medal-silver medal-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-center">
                        <div class="podium-1 w-36 rounded-t-2xl flex items-end justify-center pb-4">
                            <span class="text-4xl font-bold">1º</span>
                        </div>
                        <div class="bg-gray-700/50 w-full py-4 rounded-b-2xl text-center">
                            <span id="first-place" class="block font-bold text-2xl truncate px-2 first-place-name">---</span>
                            <span id="first-score" class="text-xl player-score">0 pts</span>
                            <div class="mt-2">
                                <i class="fas fa-crown medal-gold medal-icon"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-center">
                        <div class="podium-3 w-28 rounded-t-2xl flex items-end justify-center pb-4">
                            <span class="text-4xl font-bold">3º</span>
                        </div>
                        <div class="bg-gray-700/50 w-full py-4 rounded-b-2xl text-center">
                            <span id="third-place" class="block font-bold text-2xl truncate px-2 third-place-name">---</span>
                            <span id="third-score" class="text-xl player-score">0 pts</span>
                            <div class="mt-2">
                                <i class="fas fa-medal medal-bronze medal-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="ranking-list" class="w-full space-y-2 mb-4">
                    <!-- Ranking items will be generated by JavaScript -->
                </div>

                <!-- Container para jogador fora do top 10 -->
                <div id="player-outside-top" class="hidden w-full ranking-item">
                    <div class="player-position font-bold w-16 text-center"></div>
                    <div class="current-player-name font-bold flex-1 px-4 truncate"></div>
                    <div class="current-player-score w-24 text-right"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            score: 0,
            timeLeft: 20,
            gameInterval: null,
            activeSquares: [],
            isPlaying: false,
            currentPlayer: null,
            minActiveSquares: 2,
            maxActiveSquares: 3,
            squareActivationInterval: null,
            lastFrameTime: 0,
            lastClickTime: 0
        };

        // DOM elements
        const screens = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            thanks: document.getElementById('thanks-screen'),
            name: document.getElementById('name-screen'),
            ranking: document.getElementById('ranking-screen')
        };

        const startBtn = document.getElementById('start-btn');
        const rankingBtn = document.getElementById('ranking-btn');
        const saveBtn = document.getElementById('save-btn');
        const continueBtn = document.getElementById('continue-btn');
        const rankingBackBtn = document.getElementById('ranking-back-btn');
        const gameBoard = document.getElementById('game-board');
        const scoreDisplay = document.getElementById('score');
        const timeLeftDisplay = document.getElementById('time-left');
        const finalScoreDisplay = document.getElementById('final-score');
        const playerNameInput = document.getElementById('player-name');
        const countdownCircle = document.getElementById('countdown-circle');
        const particlesContainer = document.getElementById('particles');
        const playerOutsideTop = document.getElementById('player-outside-top');
        const playerPositionOutside = playerOutsideTop.querySelector('.player-position');
        const playerNameOutside = playerOutsideTop.querySelector('.current-player-name');
        const playerScoreOutside = playerOutsideTop.querySelector('.current-player-score');

        // Initialize the game
        function init() {
            createGameBoard();
            setupEventListeners();
            createParticles();
            preventZoomAndDoubleTap();
        }

        // Prevent zoom and double tap
        function preventZoomAndDoubleTap() {
            // Disable double tap zoom
            document.addEventListener('dblclick', function(e) {
                e.preventDefault();
            }, { passive: false });

            // Disable pinch zoom
            document.addEventListener('touchmove', function(e) {
                if (e.scale !== 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // Disable context menu
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            }, false);
        }

        // Create particles for background effect (optimized)
        function createParticles() {
            const particleCount = 15; // Reduced for performance
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'absolute rounded-full bg-white/10';
                
                const size = Math.random() * 8 + 4;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                
                const duration = Math.random() * 15 + 10;
                const delay = Math.random() * 5;
                particle.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
                
                particlesContainer.appendChild(particle);
            }
            
            // Add optimized float animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes float {
                    0%, 100% { transform: translate3d(0, 0, 0); }
                    50% { transform: translate3d(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px, 0); }
                }
            `;
            document.head.appendChild(style);
        }

        // Create the game board with squares (optimized)
        function createGameBoard() {
            gameBoard.innerHTML = '';
            const squareCount = 16; // 4x4 grid
            
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < squareCount; i++) {
                const square = document.createElement('div');
                square.className = 'square aspect-square bg-white/90 cursor-pointer';
                square.dataset.index = i;
                
                // Otimização: usar pointer events para melhor resposta ao toque
                square.addEventListener('pointerdown', function(e) {
                    e.preventDefault();
                    handleSquareClick(e);
                }, { passive: false });
                
                fragment.appendChild(square);
            }
            
            gameBoard.appendChild(fragment);
        }

        // Set up event listeners
        function setupEventListeners() {
            startBtn.addEventListener('click', startGame);
            rankingBtn.addEventListener('click', showRanking);
            saveBtn.addEventListener('click', saveScore);
            continueBtn.addEventListener('click', showNameScreen);
            rankingBackBtn.addEventListener('click', showStartScreen);
            
            // Prevent default touch behaviors
            document.addEventListener('touchstart', function(e) {
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });
            
            document.addEventListener('gesturestart', function(e) {
                e.preventDefault();
            });
        }

        // Start the game (optimized for performance)
        function startGame() {
            showScreen('game');
            resetGame();
            
            gameState.isPlaying = true;
            
            // Use requestAnimationFrame for smoother animation
            const gameLoop = (timestamp) => {
                if (!gameState.isPlaying) return;
                
                // Update game state at 60fps
                requestAnimationFrame(gameLoop);
                
                // Update game logic at consistent intervals
                if (timestamp - gameState.lastFrameTime >= 16) { // ~60fps
                    gameState.lastFrameTime = timestamp;
                    updateGame();
                }
            };
            
            requestAnimationFrame(gameLoop);
            
            // Start with 2-3 active squares
            activateRandomSquares();
            
            // Set up interval to maintain 2-3 active squares
            gameState.squareActivationInterval = setInterval(() => {
                if (gameState.activeSquares.length < gameState.minActiveSquares) {
                    activateRandomSquares();
                }
            }, 200); // Reduced interval for faster response (200ms)
            
            const circumference = 2 * Math.PI * 45;
            countdownCircle.style.strokeDasharray = circumference;
            countdownCircle.style.strokeDashoffset = circumference;
            
            const countdownInterval = setInterval(() => {
                gameState.timeLeft--;
                timeLeftDisplay.textContent = gameState.timeLeft;
                
                const offset = circumference * (gameState.timeLeft / 20);
                countdownCircle.style.strokeDashoffset = offset;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    endGame();
                }
            }, 1000);
        }

        // Update game state (optimized)
        function updateGame() {
            scoreDisplay.textContent = gameState.score;
        }

        // Activate random squares (optimized)
        function activateRandomSquares() {
            if (!gameState.isPlaying) return;
            
            const squares = document.querySelectorAll('.square');
            
            // Remove squares that are no longer active
            squares.forEach((square, index) => {
                if (!gameState.activeSquares.includes(index) && square.classList.contains('active')) {
                    square.classList.remove('active');
                }
            });
            
            // Determine how many squares to activate (between min and max)
            const squaresToActivate = Math.max(0,
                Math.min(
                    gameState.maxActiveSquares - gameState.activeSquares.length,
                    squares.length - gameState.activeSquares.length
                )
            );
            
            if (squaresToActivate <= 0) return;
            
            // Get inactive squares
            const inactiveSquares = Array.from(squares)
                .map((_, index) => index)
                .filter(index => !gameState.activeSquares.includes(index));
            
            if (inactiveSquares.length === 0) return;
            
            // Activate new squares
            for (let i = 0; i < squaresToActivate; i++) {
                if (inactiveSquares.length === 0) break;
                
                const randomIndex = Math.floor(Math.random() * inactiveSquares.length);
                const squareIndex = inactiveSquares[randomIndex];
                const square = squares[squareIndex];
                
                square.classList.add('active');
                gameState.activeSquares.push(squareIndex);
                
                // Remove from inactive squares
                inactiveSquares.splice(randomIndex, 1);
            }
        }

        // Handle square click (optimized for instant response)
        function handleSquareClick(e) {
            if (!gameState.isPlaying) return;
            
            const square = e.target;
            const index = parseInt(square.dataset.index);
            
            if (gameState.activeSquares.includes(index)) {
                gameState.score++;
                scoreDisplay.textContent = gameState.score;
                square.classList.remove('active');
                
                square.classList.add('shake');
                setTimeout(() => {
                    square.classList.remove('shake');
                }, 300);
                
                const squareIndex = gameState.activeSquares.indexOf(index);
                if (squareIndex > -1) {
                    gameState.activeSquares.splice(squareIndex, 1);
                }
                
                // Activate a new square immediately to maintain the count
                setTimeout(() => {
                    activateRandomSquares();
                }, 0); // No delay for immediate response
            } else {
                // Flash red for wrong click
                square.classList.add('wrong');
                setTimeout(() => {
                    square.classList.remove('wrong');
                }, 200);
            }
        }

        // End the game
        function endGame() {
            gameState.isPlaying = false;
            clearInterval(gameState.squareActivationInterval);
            
            document.querySelectorAll('.square').forEach(square => {
                square.classList.remove('active', 'wrong');
            });
            gameState.activeSquares = [];
            
            showScreen('thanks');
        }

        // Show name input screen
        function showNameScreen() {
            finalScoreDisplay.textContent = gameState.score;
            showScreen('name');
        }

        // Save player score (optimized)
        function saveScore() {
            const name = playerNameInput.value.trim();
            if (!name) {
                alert('POR FAVOR, DIGITE SEU NOME!');
                return;
            }
            
            const trimmedName = name.substring(0, 20);
            
            gameState.currentPlayer = {
                name: trimmedName.toUpperCase(),
                score: gameState.score
            };
            
            saveToLocalStorage(gameState.currentPlayer);
            showRanking();
        }

        // Save to localStorage (optimized)
        function saveToLocalStorage(player) {
            let ranking = JSON.parse(localStorage.getItem('reflexGameRanking')) || [];
            ranking.push(player);
            
            // Optimized sorting - only sort when needed
            if (ranking.length > 1) {
                ranking.sort((a, b) => b.score - a.score);
            }
            
            if (ranking.length > 50) {
                ranking = ranking.slice(0, 50);
            }
            
            localStorage.setItem('reflexGameRanking', JSON.stringify(ranking));
        }

        // Show ranking screen (optimized)
        function showRanking() {
            showScreen('ranking');
            const ranking = JSON.parse(localStorage.getItem('reflexGameRanking')) || [];
            
            if (ranking.length > 0) {
                document.getElementById('first-place').textContent = ranking[0].name;
                document.getElementById('first-score').textContent = `${ranking[0].score} pts`;
            }
            
            if (ranking.length > 1) {
                document.getElementById('second-place').textContent = ranking[1].name;
                document.getElementById('second-score').textContent = `${ranking[1].score} pts`;
            }
            
            if (ranking.length > 2) {
                document.getElementById('third-place').textContent = ranking[2].name;
                document.getElementById('third-score').textContent = `${ranking[2].score} pts`;
            }
            
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '';
            
            // Use document fragment for better performance
            const fragment = document.createDocumentFragment();
            
            for (let i = 3; i < Math.min(10, ranking.length); i++) {
                const player = ranking[i];
                const item = document.createElement('div');
                item.className = 'ranking-item';
                
                const position = document.createElement('div');
                position.className = 'player-position';
                position.textContent = `${i+1}º`;
                
                const name = document.createElement('div');
                name.className = 'player-name';
                name.textContent = player.name;
                
                const score = document.createElement('div');
                score.className = 'player-score';
                score.textContent = `${player.score} pts`;
                
                item.appendChild(position);
                item.appendChild(name);
                item.appendChild(score);
                
                fragment.appendChild(item);
            }
            
            rankingList.appendChild(fragment);
            
            // Mostrar jogador atual se estiver fora do top 10
            if (gameState.currentPlayer) {
                const playerIndex = ranking.findIndex(p => 
                    p.name === gameState.currentPlayer.name &&
                    p.score === gameState.currentPlayer.score
                );
                
                if (playerIndex !== -1 && playerIndex >= 10) {
                    playerOutsideTop.classList.remove('hidden');
                    playerPositionOutside.textContent = `${playerIndex + 1}º`;
                    playerNameOutside.textContent = gameState.currentPlayer.name;
                    playerScoreOutside.textContent = `${gameState.currentPlayer.score} pts`;
                } else {
                    playerOutsideTop.classList.add('hidden');
                }
            } else {
                playerOutsideTop.classList.add('hidden');
            }
        }

        // Reset game state
        function resetGame() {
            gameState.score = 0;
            gameState.timeLeft = 20;
            gameState.activeSquares = [];
            gameState.isPlaying = false;
            gameState.lastFrameTime = 0;
            gameState.lastClickTime = 0;
            
            scoreDisplay.textContent = '0';
            timeLeftDisplay.textContent = '20';
            playerNameInput.value = '';
            
            const circumference = 2 * Math.PI * 45;
            countdownCircle.style.strokeDasharray = circumference;
            countdownCircle.style.strokeDashoffset = circumference;
            
            if (gameState.squareActivationInterval) {
                clearInterval(gameState.squareActivationInterval);
                gameState.squareActivationInterval = null;
            }
        }

        // Show specific screen
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => {
                screen.classList.add('hidden');
            });
            
            screens[screenName].classList.remove('hidden');
        }

        // Show start screen
        function showStartScreen() {
            showScreen('start');
            resetGame();
        }

        // Initialize the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo de Reflexos - Visual M√≠dia Leme</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-size: 1.5vw;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            touch-action: manipulation;
            background: linear-gradient(45deg, #3b82f6, #f97316, #8b5cf6, #3b82f6);
            background-size: 300% 300%;
            animation: gradientBG 15s ease infinite;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        #app {
            width: 90vw;
            height: 90vh;
            max-width: 3840px;
            max-height: 2160px;
            position: relative;
            overflow: hidden;
        }
        
        .square {
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            border-radius: 1vw;
        }
        
        .square.active {
            background-color: #3b82f6;
            transform: scale(0.95);
            box-shadow: 0 0 15px #3b82f6;
        }
        
        .square.wrong {
            background-color: #ef4444;
            transform: scale(0.95);
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0) scale(0.95); }
            25% { transform: translateX(-5px) scale(0.95); }
            50% { transform: translateX(5px) scale(0.95); }
            75% { transform: translateX(-5px) scale(0.95); }
        }
        
        .shake {
            animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both;
        }
        
        /* Otimiza√ß√µes para performance */
        .square {
            will-change: transform, background-color, box-shadow;
        }
        
        /* Removemos os efeitos pesados */
        
        /* Estilos simplificados para telas */
        #game-screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            z-index: 10;
        }
        
        #game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5vw;
            width: 60vw;
        }
    </style>
</head>
<body>
    <div id="app" class="flex flex-col items-center justify-center p-4">
        <!-- Tela Inicial -->
        <div id="start-screen" class="flex flex-col items-center justify-center text-center w-full h-full relative z-10">
            <div class="logo-container flex items-center justify-center bg-white/20 rounded-full backdrop-blur-sm border-2 border-white/30" style="width: 20vw; height: 20vw; margin-bottom: 5vh;">
                <span class="text-8xl">üéÆ</span>
            </div>
            
            <h1 class="text-white bounce" style="font-size: 4vw; margin-bottom: 4vh;">JOGO DE REFLEXOS</h1>
            <div class="space-y-4 w-full max-w-xl">
                <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg pulse pixel-btn">
                    JOGAR
                </button>
                <button id="ranking-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-all duration-300 transform hover:scale-105 shadow-lg pixel-btn">
                    RANKING
                </button>
            </div>
            <div class="absolute bottom-8 text-white/80 text-xl">
                Siga nosso Instagram: <span class="font-bold">@visualmidialeme</span>
            </div>
        </div>
        
        <!-- Tela do Jogo -->
        <div id="game-screen">
            <div class="countdown-container" style="position: relative; width: 10vw; height: 10vw; margin-bottom: 3vh;">
                <svg class="countdown-svg" width="100%" height="100%" viewBox="0 0 100 100">
                    <circle class="countdown-circle-bg" cx="50" cy="50" r="45" stroke="#4b5563" stroke-width="8" fill="none"></circle>
                    <circle id="countdown-circle" class="countdown-circle" cx="50" cy="50" r="45" stroke="#3b82f6" stroke-width="8" stroke-linecap="round" fill="none"></circle>
                </svg>
                <div class="absolute inset-0 flex items-center justify-center text-4xl font-bold">
                    <span id="time-left">20</span>
                </div>
            </div>
            
            <div class="mb-8 text-3xl font-bold">
                Pontos: <span id="score">0</span>
            </div>
            
            <div id="game-board"></div>
        </div>
        
        <!-- Tela de Agradecimento -->
        <div id="thanks-screen" class="hidden w-full h-full flex flex-col items-center justify-center text-center px-8 relative z-10">
            <div class="bg-white/10 backdrop-blur-sm p-12 rounded-3xl border border-white/20 max-w-2xl w-full">
                <h2 class="font-bold mb-12">OBRIGADO POR JOGAR!</h2>
                
                <p class="text-3xl mb-12">Esperamos que tenha se divertido!</p>
                
                <div class="flex flex-col items-center space-y-6 mb-12">
                    <p class="text-2xl">Voc√™ j√° segue nosso Instagram?</p>
                    <div class="flex items-center space-x-4">
                        <span class="instagram-pixel"></span>
                        <span class="font-bold text-3xl">@visualmidialeme</span>
                    </div>
                </div>
                
                <button id="continue-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg pixel-btn w-full text-3xl py-6">
                    CONTINUAR PARA O RANKING
                </button>
            </div>
        </div>
        
        <!-- Tela de Cadastro de Nome -->
        <div id="name-screen" class="hidden w-full h-full flex flex-col items-center justify-center text-center px-8 relative z-10">
            <div class="bg-white/10 backdrop-blur-sm p-12 rounded-3xl border border-white/20 max-w-2xl w-full">
                <h2 class="font-bold mb-8">REGISTRE SEU NOME</h2>
                <p class="text-3xl mb-12">Sua pontua√ß√£o: <span id="final-score" class="font-bold text-blue-400">0</span></p>
                
                <div class="w-full mb-12">
                    <label for="player-name" class="block text-2xl mb-4">DIGITE SEU NOME:</label>
                    <input type="text" id="player-name" maxlength="20" class="w-full rounded-xl text-gray-800 text-center font-bold" placeholder="SEU NICK">
                </div>
                
                <button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg pixel-btn text-3xl py-6">
                    SALVAR E VER RANKING
                </button>
            </div>
        </div>
        
        <!-- Tela de Ranking -->
        <div id="ranking-screen" class="hidden w-full h-full flex flex-col items-center justify-start pt-16 px-8 relative z-10">
            <div class="bg-white/10 backdrop-blur-sm p-8 rounded-3xl border border-white/20 w-full max-w-4xl">
                <div class="ranking-title mb-12">
                    <h2 class="text-5xl font-bold text-yellow-400">RANKING</h2>
                </div>
                
                <div class="flex items-end justify-center space-x-8 mb-16 w-full">
                    <div class="flex flex-col items-center">
                        <div class="podium-2 w-32 rounded-t-2xl flex items-end justify-center pb-4">
                            <span class="text-4xl font-bold">2¬∫</span>
                        </div>
                        <div class="bg-gray-700/50 w-full py-4 rounded-b-2xl text-center">
                            <span id="second-place" class="block font-bold text-2xl truncate px-2 second-place-name">---</span>
                            <span id="second-score" class="text-xl player-score">0 pts</span>
                            <div class="mt-2 medal-silver text-4xl">ü•à</div>
                        </div>
                    </div>
                                    
                    <div class="flex flex-col items-center">
                        <div class="podium-1 w-40 rounded-t-2xl flex items-end justify-center pb-4">
                            <span class="text-4xl font-bold">1¬∫</span>
                        </div>
                        <div class="bg-gray-700/50 w-full py-4 rounded-b-2xl text-center">
                            <span id="first-place" class="block font-bold text-2xl truncate px-2 first-place-name">---</span>
                            <span id="first-score" class="text-xl player-score">0 pts</span>
                            <div class="mt-2 medal-gold text-4xl">ü•á</div>
                        </div>
                    </div>
                                    
                    <div class="flex flex-col items-center">
                        <div class="podium-3 w-32 rounded-t-2xl flex items-end justify-center pb-4">
                            <span class="text-4xl font-bold">3¬∫</span>
                        </div>
                        <div class="bg-gray-700/50 w-full py-4 rounded-b-2xl text-center">
                            <span id="third-place" class="block font-bold text-2xl truncate px-2 third-place-name">---</span>
                            <span id="third-score" class="text-xl player-score">0 pts</span>
                            <div class="mt-2 medal-bronze text-4xl">ü•â</div>
                        </div>
                    </div>
                </div>
                
                <div id="ranking-list" class="w-full space-y-4 mb-12">
                    <!-- Ranking items will be generated by JavaScript -->
                </div>
                
                <div id="current-player" class="w-full bg-blue-500/30 p-6 rounded-2xl mb-8 hidden">
                    <h3 class="font-bold mb-4 text-2xl">SUA POSI√á√ÉO:</h3>
                    <div id="player-position" class="text-3xl truncate"></div>
                </div>
                
                <button id="back-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg w-full pixel-btn text-3xl py-6">
                    VOLTAR AO IN√çCIO
                </button>
            </div>
        </div>
    </div>

    <script>
        // Game state
        const gameState = {
            score: 0,
            timeLeft: 20,
            gameInterval: null,
            activeSquares: [],
            isPlaying: false,
            currentPlayer: null,
            minActiveSquares: 2,
            maxActiveSquares: 3,
            squareActivationInterval: null,
            lastActivationTime: 0
        };

        // DOM elements
        const screens = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            thanks: document.getElementById('thanks-screen'),
            name: document.getElementById('name-screen'),
            ranking: document.getElementById('ranking-screen')
        };

        const startBtn = document.getElementById('start-btn');
        const rankingBtn = document.getElementById('ranking-btn');
        const saveBtn = document.getElementById('save-btn');
        const backBtn = document.getElementById('back-btn');
        const continueBtn = document.getElementById('continue-btn');
        const gameBoard = document.getElementById('game-board');
        const scoreDisplay = document.getElementById('score');
        const timeLeftDisplay = document.getElementById('time-left');
        const finalScoreDisplay = document.getElementById('final-score');
        const playerNameInput = document.getElementById('player-name');
        const countdownCircle = document.getElementById('countdown-circle');

        // Initialize the game
        function init() {
            createGameBoard();
            setupEventListeners();
        }

        // Create the game board with squares
        function createGameBoard() {
            gameBoard.innerHTML = '';
            const squareCount = 16; // 4x4 grid
            
            for (let i = 0; i < squareCount; i++) {
                const square = document.createElement('div');
                square.className = 'square aspect-square bg-white/90 cursor-pointer';
                square.dataset.index = i;
                square.style.aspectRatio = '1/1';
                square.addEventListener('click', handleSquareClick);
                gameBoard.appendChild(square);
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            startBtn.addEventListener('click', startGame);
            rankingBtn.addEventListener('click', showRanking);
            saveBtn.addEventListener('click', saveScore);
            backBtn.addEventListener('click', showStartScreen);
            continueBtn.addEventListener('click', showNameScreen);
        }

        // Start the game
        function startGame() {
            showScreen('game');
            resetGame();
            
            gameState.isPlaying = true;
            gameState.gameInterval = setInterval(updateGame, 1000);
            
            // Start with 2-3 active squares
            activateRandomSquares();
            
            // Set up interval to maintain 2-3 active squares (otimizado)
            gameState.squareActivationInterval = setInterval(() => {
                const now = Date.now();
                if (now - gameState.lastActivationTime > 300) { // Limita a ativa√ß√£o a cada 300ms
                    maintainActiveSquares();
                    gameState.lastActivationTime = now;
                }
            }, 100);
            
            const circumference = 2 * Math.PI * 45;
            countdownCircle.style.strokeDasharray = circumference;
            countdownCircle.style.strokeDashoffset = circumference;
            
            const countdownInterval = setInterval(() => {
                gameState.timeLeft--;
                timeLeftDisplay.textContent = gameState.timeLeft;
                
                const offset = circumference * (gameState.timeLeft / 20);
                countdownCircle.style.strokeDashoffset = offset;
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    endGame();
                }
            }, 1000);
        }

        // Update game state
        function updateGame() {
            scoreDisplay.textContent = gameState.score;
        }

        // Maintain active squares count
        function maintainActiveSquares() {
            if (!gameState.isPlaying) return;
            
            const squares = document.querySelectorAll('.square');
            const activeCount = gameState.activeSquares.length;
            
            // Remove squares that are no longer active
            squares.forEach((square, index) => {
                if (!gameState.activeSquares.includes(index) && square.classList.contains('active')) {
                    square.classList.remove('active');
                }
            });
            
            // Determine how many squares we need to activate
            const targetCount = Math.min(
                gameState.maxActiveSquares,
                Math.max(gameState.minActiveSquares, activeCount)
            );
            
            if (activeCount >= targetCount) return;
            
            // Get inactive squares
            const inactiveSquares = Array.from(squares)
                .map((_, index) => index)
                .filter(index => !gameState.activeSquares.includes(index));
            
            if (inactiveSquares.length === 0) return;
            
            // Activate new squares
            const squaresToActivate = Math.min(
                targetCount - activeCount,
                inactiveSquares.length
            );
            
            for (let i = 0; i < squaresToActivate; i++) {
                const randomIndex = Math.floor(Math.random() * inactiveSquares.length);
                const squareIndex = inactiveSquares[randomIndex];
                const square = squares[squareIndex];
                
                square.classList.add('active');
                gameState.activeSquares.push(squareIndex);
                
                // Remove from inactive squares
                inactiveSquares.splice(randomIndex, 1);
            }
        }

        // Activate random squares (initial activation)
        function activateRandomSquares() {
            if (!gameState.isPlaying) return;
            
            const squares = document.querySelectorAll('.square');
            const targetCount = Math.floor(Math.random() * 2) + gameState.minActiveSquares; // 2 ou 3
            
            // Clear any existing active squares
            gameState.activeSquares = [];
            
            // Get all possible indices
            const allIndices = Array.from(squares).map((_, index) => index);
            
            // Activate targetCount squares
            for (let i = 0; i < targetCount; i++) {
                if (allIndices.length === 0) break;
                
                const randomIndex = Math.floor(Math.random() * allIndices.length);
                const squareIndex = allIndices[randomIndex];
                const square = squares[squareIndex];
                
                square.classList.add('active');
                gameState.activeSquares.push(squareIndex);
                
                // Remove from available indices
                allIndices.splice(randomIndex, 1);
            }
        }

        // Handle square click (otimizado)
        function handleSquareClick(e) {
            if (!gameState.isPlaying) return;
            
            const square = e.target;
            const index = parseInt(square.dataset.index);
            
            if (gameState.activeSquares.includes(index)) {
                gameState.score++;
                scoreDisplay.textContent = gameState.score;
                square.classList.remove('active');
                
                // Apenas o efeito de shake (leve)
                square.classList.add('shake');
                setTimeout(() => {
                    square.classList.remove('shake');
                }, 300);
                
                // Remove from active squares
                const squareIndex = gameState.activeSquares.indexOf(index);
                if (squareIndex > -1) {
                    gameState.activeSquares.splice(squareIndex, 1);
                }
                
                // Ativa um novo quadrado imediatamente
                setTimeout(() => {
                    maintainActiveSquares();
                }, 50);
            } else {
                square.classList.add('wrong');
                setTimeout(() => {
                    square.classList.remove('wrong');
                }, 300);
            }
        }

        // End the game
        function endGame() {
            gameState.isPlaying = false;
            clearInterval(gameState.gameInterval);
            clearInterval(gameState.squareActivationInterval);
            
            document.querySelectorAll('.square').forEach(square => {
                square.classList.remove('active', 'wrong', 'shake');
            });
            gameState.activeSquares = [];
            
            showScreen('thanks');
        }

        // Show name input screen
        function showNameScreen() {
            finalScoreDisplay.textContent = gameState.score;
            showScreen('name');
        }

        // Save player score
        function saveScore() {
            const name = playerNameInput.value.trim();
            if (!name) {
                alert('POR FAVOR, DIGITE SEU NOME!');
                return;
            }
            
            const trimmedName = name.substring(0, 20);
            
            gameState.currentPlayer = {
                name: trimmedName.toUpperCase(),
                score: gameState.score
            };
            
            saveToLocalStorage(gameState.currentPlayer);
            showRanking();
        }

        // Save to localStorage
        function saveToLocalStorage(player) {
            let ranking = JSON.parse(localStorage.getItem('reflexGameRanking')) || [];
            ranking.push(player);
            
            ranking.sort((a, b) => b.score - a.score);
            
            if (ranking.length > 50) {
                ranking = ranking.slice(0, 50);
            }
            
            localStorage.setItem('reflexGameRanking', JSON.stringify(ranking));
        }

        // Show ranking screen
        function showRanking() {
            showScreen('ranking');
            const ranking = JSON.parse(localStorage.getItem('reflexGameRanking')) || [];
            
            if (ranking.length > 0) {
                document.getElementById('first-place').textContent = ranking[0].name;
                document.getElementById('first-score').textContent = `${ranking[0].score} pts`;
            }
            
            if (ranking.length > 1) {
                document.getElementById('second-place').textContent = ranking[1].name;
                document.getElementById('second-score').textContent = `${ranking[1].score} pts`;
            }
            
            if (ranking.length > 2) {
                document.getElementById('third-place').textContent = ranking[2].name;
                document.getElementById('third-score').textContent = `${ranking[2].score} pts`;
            }
            
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '';
            
            for (let i = 3; i < Math.min(10, ranking.length); i++) {
                const player = ranking[i];
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-gray-700/30 p-4 rounded-xl ranking-item';
                
                const position = document.createElement('div');
                position.className = 'player-position font-bold w-16 text-center';
                position.textContent = `${i+1}¬∫`;
                
                const name = document.createElement('div');
                name.className = 'player-name font-bold flex-1 px-4 truncate';
                name.textContent = player.name;
                
                const score = document.createElement('div');
                score.className = 'player-score w-24 text-right';
                score.textContent = `${player.score} pts`;
                
                item.appendChild(position);
                item.appendChild(name);
                item.appendChild(score);
                
                rankingList.appendChild(item);
            }
            
            if (gameState.currentPlayer) {
                const currentPlayerContainer = document.getElementById('current-player');
                const playerPositionElement = document.getElementById('player-position');
                
                const playerIndex = ranking.findIndex(p => 
                    p.name === gameState.currentPlayer.name && 
                    p.score === gameState.currentPlayer.score
                );
                
                if (playerIndex !== -1) {
                    currentPlayerContainer.classList.remove('hidden');
                    
                    let positionText = `${playerIndex + 1}¬∫`;
                    if (playerIndex === 0) positionText = 'ü•á 1¬∫';
                    else if (playerIndex === 1) positionText = 'ü•à 2¬∫';
                    else if (playerIndex === 2) positionText = 'ü•â 3¬∫';
                    
                    playerPositionElement.innerHTML = `
                        <span class="player-position">${positionText}</span> - 
                        <span class="current-player-name">${gameState.currentPlayer.name}</span>
                        (<span class="player-score">${gameState.currentPlayer.score} pts</span>)
                    `;
                }
            }
        }

        // Reset game state
        function resetGame() {
            gameState.score = 0;
            gameState.timeLeft = 20;
            gameState.activeSquares = [];
            gameState.isPlaying = false;
            gameState.lastActivationTime = 0;
            
            scoreDisplay.textContent = '0';
            timeLeftDisplay.textContent = '20';
            playerNameInput.value = '';
            
            const circumference = 2 * Math.PI * 45;
            countdownCircle.style.strokeDasharray = circumference;
            countdownCircle.style.strokeDashoffset = circumference;
            
            if (gameState.squareActivationInterval) {
                clearInterval(gameState.squareActivationInterval);
                gameState.squareActivationInterval = null;
            }
        }

        // Show specific screen
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => {
                screen.style.display = 'none';
            });
            
            screens[screenName].style.display = 'flex';
        }

        // Show start screen
        function showStartScreen() {
            showScreen('start');
            resetGame();
        }

        // Initialize the game when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
